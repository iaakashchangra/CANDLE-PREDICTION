{% extends "base.html" %}

{% block title %}User Selections - Candlestick Predictor{% endblock %}

{% block extra_head %}
<style>
    .selection-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .config-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        color: #333;
    }
    .selected-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin: 5px;
        display: inline-block;
    }
    .btn-gradient {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        color: white;
    }
    .user-config-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
    }
    .user-config-card.selected {
        border-color: #007bff;
        background: #e7f3ff;
    }
    .user-settings {
        display: none;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }
    .user-settings.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 mb-3">
                <i class="fas fa-users-cog text-primary me-3"></i>
                User Selections
            </h1>
            <p class="lead text-muted">Create and manage prediction configurations for multiple users</p>
        </div>
    </div>

    <!-- Create New Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <button class="btn btn-gradient btn-lg" data-bs-toggle="modal" data-bs-target="#createSelectionModal">
                <i class="fas fa-plus me-2"></i>Create New Selection
            </button>
        </div>
    </div>

    <!-- Existing Selections -->
    <div class="row" id="selections-container">
        <!-- Selection cards will be dynamically added here -->
    </div>

    <!-- Create Selection Modal -->
    <div class="modal fade" id="createSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Create New Selection
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="selectionForm">
                        <!-- Basic Info -->
                        <div class="mb-4">
                            <label class="form-label">Selection Name</label>
                            <input type="text" class="form-control" name="name" required>
                            <div class="form-text">Give your selection a descriptive name</div>
                        </div>

                        <!-- Users Selection with Individual Configurations -->
                        <div class="config-section">
                            <h5><i class="fas fa-users me-2"></i>Configure Users</h5>
                            <div class="user-config-list mt-3" id="userConfigList">
                                <!-- User configuration cards will be dynamically added here -->
                            </div>
                        </div>

                        <!-- Models Selection -->
                        <div class="config-section">
                            <h5><i class="fas fa-brain me-2"></i>Select Models</h5>
                            <div class="model-list mt-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="models" value="lstm">
                                    <label class="form-check-label">LSTM</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="models" value="cnn">
                                    <label class="form-check-label">CNN</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="models" value="rnn">
                                    <label class="form-check-label">RNN</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="models" value="hybrid">
                                    <label class="form-check-label">Hybrid</label>
                                </div>
                            </div>
                        </div>

                        <!-- Companies Selection -->
                        <div class="config-section">
                            <h5><i class="fas fa-building me-2"></i>Select Companies</h5>
                            <select class="form-select" name="companies" multiple required>
                                <option value="AAPL">Apple Inc. (AAPL)</option>
                                <option value="GOOGL">Alphabet Inc. (GOOGL)</option>
                                <option value="MSFT">Microsoft Corporation (MSFT)</option>
                                <option value="AMZN">Amazon.com Inc. (AMZN)</option>
                                <option value="TSLA">Tesla Inc. (TSLA)</option>
                            </select>
                        </div>

                        <!-- Global Prediction Settings -->
                        <div class="config-section">
                            <h5><i class="fas fa-chart-line me-2"></i>Global Prediction Settings</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Default Candles to Predict (n)</label>
                                    <input type="number" class="form-control" name="default_prediction_count" value="5" min="1" max="50">
                                    <div class="form-text">Number of future candles to predict</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Risk Level</label>
                                    <select class="form-select" name="risk_level">
                                        <option value="conservative">Conservative</option>
                                        <option value="moderate" selected>Moderate</option>
                                        <option value="aggressive">Aggressive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-gradient" onclick="createSelection()">Create Selection</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script>
    // Load existing selections on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSelections();
        loadUsers();
    });

    // Load users for configuration
    function loadUsers() {
        fetch('/api/users')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const userConfigList = document.getElementById('userConfigList');
                    data.users.forEach(user => {
                        const userCard = document.createElement('div');
                        userCard.className = 'user-config-card';
                        userCard.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input user-checkbox" type="checkbox" name="users" value="${user.id}" 
                                       onchange="toggleUserSettings(this, ${user.id})">
                                <label class="form-check-label fw-bold">${user.username}</label>
                            </div>
                            <div class="user-settings" id="settings-${user.id}">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Stock Symbols</label>
                                        <select class="form-select" name="user_${user.id}_symbols" multiple>
                                            <option value="AAPL">Apple (AAPL)</option>
                                            <option value="GOOGL">Alphabet (GOOGL)</option>
                                            <option value="MSFT">Microsoft (MSFT)</option>
                                            <option value="AMZN">Amazon (AMZN)</option>
                                            <option value="TSLA">Tesla (TSLA)</option>
                                            <option value="META">Meta (META)</option>
                                            <option value="NVDA">NVIDIA (NVDA)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Timeframes</label>
                                        <select class="form-select" name="user_${user.id}_timeframes" multiple>
                                            <option value="1m">1 Minute</option>
                                            <option value="5m">5 Minutes</option>
                                            <option value="15m">15 Minutes</option>
                                            <option value="30m">30 Minutes</option>
                                            <option value="1h">1 Hour</option>
                                            <option value="4h">4 Hours</option>
                                            <option value="1d">1 Day</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ML Models</label>
                                        <select class="form-select" name="user_${user.id}_models" multiple>
                                            <option value="lstm">LSTM</option>
                                            <option value="cnn">CNN</option>
                                            <option value="rnn">RNN</option>
                                            <option value="hybrid">Hybrid</option>
                                            <option value="statistical">Statistical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Candles to Predict (n)</label>
                                        <input type="number" class="form-control" name="user_${user.id}_prediction_count" 
                                               value="5" min="1" max="50">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Risk Level</label>
                                        <select class="form-select" name="user_${user.id}_risk_level">
                                            <option value="conservative">Conservative</option>
                                            <option value="moderate" selected>Moderate</option>
                                            <option value="aggressive">Aggressive</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `;
                        userConfigList.appendChild(userCard);
                    });
                }
            });
    }

    // Toggle user settings visibility
    function toggleUserSettings(checkbox, userId) {
        const settings = document.getElementById(`settings-${userId}`);
        const card = checkbox.closest('.user-config-card');
        
        if (checkbox.checked) {
            settings.classList.add('show');
            card.classList.add('selected');
        } else {
            settings.classList.remove('show');
            card.classList.remove('selected');
        }
    }

    // Load existing selections
    function loadSelections() {
        fetch('/api/selections')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('selections-container');
                    container.innerHTML = '';
                    data.selections.forEach(selection => {
                        container.appendChild(createSelectionCard(selection));
                    });
                }
            });
    }

    // Create a selection card element
    function createSelectionCard(selection) {
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-4';
        
        // Build user configurations display
        let userConfigsHtml = '';
        if (selection.user_configurations && selection.user_configurations.length > 0) {
            userConfigsHtml = selection.user_configurations.map(config => `
                <div class="user-config-summary mb-2 p-2" style="background: rgba(255,255,255,0.1); border-radius: 5px;">
                    <strong>${config.username || `User ${config.user_id}`}</strong>
                    <div class="small mt-1">
                        <div><i class="fas fa-chart-line me-1"></i>Candles: ${config.prediction_count}</div>
                        <div><i class="fas fa-building me-1"></i>Symbols: ${config.symbols ? config.symbols.join(', ') : 'N/A'}</div>
                        <div><i class="fas fa-clock me-1"></i>Timeframes: ${config.timeframes ? config.timeframes.join(', ') : 'N/A'}</div>
                        <div><i class="fas fa-brain me-1"></i>Models: ${config.models ? config.models.join(', ') : 'N/A'}</div>
                        <div><i class="fas fa-shield-alt me-1"></i>Risk: ${config.risk_level || 'moderate'}</div>
                    </div>
                </div>
            `).join('');
        } else {
            // Fallback to old format for backward compatibility
            userConfigsHtml = `
                <div class="config-section mb-3">
                    <h6><i class="fas fa-users me-2"></i>Selected Users</h6>
                    ${selection.selected_users ? selection.selected_users.map(user => 
                        `<span class="selected-item">${user.username}</span>`
                    ).join('') : 'No users selected'}
                </div>
                <div class="config-section mb-3">
                    <h6><i class="fas fa-brain me-2"></i>Selected Models</h6>
                    ${selection.selected_models ? selection.selected_models.map(model => 
                        `<span class="selected-item">${model.model_type}</span>`
                    ).join('') : 'No models selected'}
                </div>
                <div class="config-section mb-3">
                    <h6><i class="fas fa-building me-2"></i>Selected Companies</h6>
                    ${selection.selected_companies ? selection.selected_companies.map(company => 
                        `<span class="selected-item">${company.symbol}</span>`
                    ).join('') : 'No companies selected'}
                </div>
                <div class="config-section mb-3">
                    <h6><i class="fas fa-clock me-2"></i>Selected Timeframes</h6>
                    ${selection.selected_timeframes ? selection.selected_timeframes.map(timeframe => 
                        `<span class="selected-item">${timeframe.timeframe}</span>`
                    ).join('') : 'No timeframes selected'}
                </div>
            `;
        }
        
        card.innerHTML = `
            <div class="selection-card">
                <h4 class="mb-3">${selection.name}</h4>
                <div class="config-section mb-3">
                    <h6><i class="fas fa-cogs me-2"></i>User Configurations</h6>
                    ${userConfigsHtml}
                </div>
                <div class="d-flex justify-content-between mt-4">
                    <button class="btn btn-light" onclick="runSelection(${selection.id})">
                        <i class="fas fa-play me-2"></i>Run Predictions
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelection(${selection.id})">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </div>
            </div>
        `;
        return card;
    }

    // Create new selection
    function createSelection() {
        const form = document.getElementById('selectionForm');
        const formData = new FormData(form);
        
        // Get selected users
        const selectedUsers = Array.from(formData.getAll('users'));
        
        if (selectedUsers.length === 0) {
            alert('Please select at least one user.');
            return;
        }
        
        // Build user configurations
        const userConfigurations = [];
        selectedUsers.forEach(userId => {
            const symbols = Array.from(form.querySelectorAll(`select[name="user_${userId}_symbols"] option:checked`)).map(opt => opt.value);
            const timeframes = Array.from(form.querySelectorAll(`select[name="user_${userId}_timeframes"] option:checked`)).map(opt => opt.value);
            const models = Array.from(form.querySelectorAll(`select[name="user_${userId}_models"] option:checked`)).map(opt => opt.value);
            const predictionCount = form.querySelector(`input[name="user_${userId}_prediction_count"]`).value;
            const riskLevel = form.querySelector(`select[name="user_${userId}_risk_level"]`).value;
            
            if (symbols.length === 0 || timeframes.length === 0 || models.length === 0) {
                alert(`Please configure all settings for user ${userId}`);
                return;
            }
            
            userConfigurations.push({
                user_id: parseInt(userId),
                symbols: symbols,
                timeframes: timeframes,
                models: models,
                prediction_count: parseInt(predictionCount),
                risk_level: riskLevel
            });
        });
        
        const data = {
            name: formData.get('name'),
            description: formData.get('description') || '',
            default_prediction_count: parseInt(formData.get('default_prediction_count')),
            risk_level: formData.get('risk_level'),
            user_configurations: userConfigurations
        };

        fetch('/api/selections', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#createSelectionModal').modal('hide');
                loadSelections();
                form.reset();
                // Reset user settings visibility
                document.querySelectorAll('.user-settings').forEach(settings => {
                    settings.classList.remove('show');
                });
                document.querySelectorAll('.user-config-card').forEach(card => {
                    card.classList.remove('selected');
                });
            } else {
                alert('Error creating selection: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating selection: ' + error.message);
        });
    }

    // Run a selection
    function runSelection(selectionId) {
        fetch(`/api/run-selection/${selectionId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Selection executed successfully!');
            } else {
                alert('Error running selection: ' + data.error);
            }
        });
    }

    // Delete a selection
    function deleteSelection(selectionId) {
        if (confirm('Are you sure you want to delete this selection?')) {
            fetch(`/api/selections/${selectionId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSelections();
                } else {
                    alert('Error deleting selection: ' + data.error);
                }
            });
        }
    }
</script>
{% endblock %}
{% endblock %}