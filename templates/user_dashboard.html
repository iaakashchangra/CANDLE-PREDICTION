{% extends "base.html" %}

{% block title %}User Dashboard - Personalized Predictions{% endblock %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .sub-users-section {
            margin-top: 2rem;
        }

        .predictions-grid .card {
            height: 100%;
        }

        .sub-user-config {
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }

        .sub-user-config:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }
        
        .user-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }
        
        .user-preferences {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <header class="header">
            <h1>User Dashboard</h1>
            <p>Your Personalized Stock Predictions</p>
        </header>

        <div class="user-info">
            <div class="user-details">
                <div class="user-avatar">{{ current_user.username[0] | upper }}</div>
                <div class="user-name">{{ current_user.username }}</div>
            </div>
            <div class="user-preferences">
                <div class="preference-item">
                    <div class="preference-label">Preferred Symbol</div>
                    <div class="preference-value">{{ user_preferences.default_symbol if user_preferences else 'AAPL' }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Timeframe</div>
                    <div class="preference-value">{{ user_preferences.default_timeframe if user_preferences else '1d' }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Model</div>
                    <div class="preference-value">{{ user_preferences.preferred_model if user_preferences else 'LSTM' }}</div>
                </div>
            </div>
        </div>

        <!-- Sub-User Management Section -->
        <div class="sub-users-section mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Sub-User Management</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Number of Sub-Users</label>
                            <input type="number" class="form-control" id="subUserCount" min="1" max="10" value="1">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary" onclick="generateSubUsers()">Generate</button>
                        </div>
                    </div>

                    <div id="subUsersContainer">
                        <!-- Sub-user configurations will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictions Grid -->
        <div class="predictions-grid mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Live Predictions</h5>
                </div>
                <div class="card-body">
                    <div id="predictionsGrid" class="row">
                        <!-- Prediction charts will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sub-User Management Section -->
        <div class="sub-users-section mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Sub-User Management</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Number of Sub-Users</label>
                            <input type="number" class="form-control" id="subUserCount" min="1" max="10" value="1">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary" onclick="generateSubUsers()">Generate</button>
                        </div>
                    </div>

                    <div id="subUsersContainer">
                        <!-- Sub-user configurations will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Predictions Grid -->
        <div class="predictions-grid mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Live Predictions</h5>
                </div>
                <div class="card-body">
                    <div id="predictionsGrid" class="row">
                        <!-- Prediction charts will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
            <div class="user-details">
                <div class="user-avatar">{{ current_user.username[0] | upper }}</div>
                <div class="user-name">{{ current_user.username }}</div>
            </div>
            <div class="user-preferences">
                <div class="preference-item">
                    <div class="preference-label">Preferred Symbol</div>
                    <div class="preference-value">{{ user_preferences.default_symbol if user_preferences else 'AAPL' }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Timeframe</div>
                    <div class="preference-value">{{ user_preferences.default_timeframe if user_preferences else '1d' }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Model</div>
                    <div class="preference-value">{{ user_preferences.preferred_model if user_preferences else 'LSTM' }}</div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="statistics-section">
            <div class="section-header">
                <h2>Platform Statistics</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ user_stats.total_users }}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ user_stats.active_users }}</div>
                    <div class="stat-label">Active Users</div>
                </div>
            </div>
        </div>

        <!-- Prediction Configuration Section -->
        <div class="prediction-config-section">
            <div class="section-header">
                <h2>Configure Predictions</h2>
            </div>
            <div class="config-grid">
                <!-- Symbol Selection -->
                <div class="config-card">
                    <h3>Stock Symbols</h3>
                    <div class="popular-list">
                        <h4>Popular Symbols</h4>
                        {% for symbol, count in (user_stats.get('popular_symbols', {}) or {}).items() %}
                        <div class="popular-item">
                            <span class="item-name">{{ symbol }}</span>
                            <span class="item-count">({{ count }})</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="selection-area">
                        <select id="symbol-select" class="config-select">
                            {% for symbol in available_symbols %}
                            <option value="{{ symbol }}">{{ symbol }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Timeframe Selection -->
                <div class="config-card">
                    <h3>Timeframes</h3>
                    <div class="popular-list">
                        <h4>Popular Timeframes</h4>
                        {% for timeframe, count in (user_stats.get('popular_timeframes', {}) or {}).items() %}
                        <div class="popular-item">
                            <span class="item-name">{{ timeframe }}</span>
                            <span class="item-count">({{ count }})</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="selection-area">
                        <select id="timeframe-select" class="config-select">
                            {% for timeframe in available_timeframes %}
                            <option value="{{ timeframe }}">{{ timeframe }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Model Selection -->
                <div class="config-card">
                    <h3>ML Models</h3>
                    <div class="popular-list">
                        <h4>Popular Models</h4>
                        {% if user_stats and user_stats.popular_models %}
                            {% for model, count in user_stats.popular_models.items() %}
                            <div class="popular-item">
                                <span class="item-name">{{ model }}</span>
                                <span class="item-count">({{ count }})</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="popular-item">
                                <span class="item-name">No model usage data available</span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="selection-area">
                        <select id="model-select" class="config-select">
                            {% for model in available_models %}
                            <option value="{{ model }}">{{ model }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Prediction Count -->
                <div class="config-card">
                    <h3>Number of Predictions</h3>
                    <div class="selection-area">
                        <input type="number" id="prediction-count" class="config-input" min="1" max="50" value="5">
                    </div>
                </div>
            </div>

            <div class="action-area">
                <button id="generate-predictions" class="btn btn-primary">Generate Predictions</button>
            </div>
        </div>

        /* Statistics Section Styles */
        .statistics-section {
            padding: 30px;
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 1.8em;
            color: #333;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        /* Prediction Configuration Styles */
        .prediction-config-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .config-card h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.4em;
        }

        .popular-list {
            margin-bottom: 20px;
        }

        .popular-list h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .popular-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .item-name {
            color: #333;
            font-weight: 500;
        }

        .item-count {
            color: #666;
        }

        .selection-area {
            margin-top: 15px;
        }

        .config-select,
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
        }

        .config-select:focus,
        .config-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-area {
            text-align: center;
        }

        .preference-item {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        
        .preference-label {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 2px;
        }
        
        .preference-value {
            color: #333;
            font-weight: 600;
        }
        
        .controls-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        
        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .predictions-section {
            padding: 30px;
        }
        
        .predictions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .predictions-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
        }
        
        .predictions-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .prediction-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s;
        }
        
        .prediction-card:hover {
            transform: translateY(-5px);
        }

        /* New styles for statistics and configuration sections */
        .statistics-section,
        .prediction-config-section {
            padding: 30px;
            background: white;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.8em;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .config-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .config-card h3 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .popular-list {
            margin-bottom: 15px;
        }

        .popular-list h4 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .popular-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .item-count {
            color: #666;
        }

        .selection-area {
            margin-top: 15px;
        }

        .config-select,
        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .action-area {
            margin-top: 30px;
            text-align: center;
        }
        
        .data-source-warning {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
        }
        
        .data-source-info {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .prediction-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .info-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 120px;
        }
        
        .prediction-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .prediction-symbol {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .prediction-meta {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .prediction-content {
            padding: 20px;
        }
        
        .prediction-chart {
            height: 300px;
            margin-bottom: 20px;
        }
        
        .prediction-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .summary-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }
        
        .summary-label {
            font-size: 0.8em;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .export-section {
            background: #fff;
            padding: 25px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .export-section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .export-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .export-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .export-form h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn.csv {
            background: #28a745;
            color: white;
        }
        
        .export-btn.csv:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .export-btn.pdf {
            background: #dc3545;
            color: white;
        }
        
        .export-btn.pdf:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .export-stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .export-stats h5 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        /* Chart controls styles */
        .chart-controls {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .chart-controls .control-group {
            margin-bottom: 5px;
            flex: 1;
            min-width: 150px;
        }
        
        .chart-controls .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .chart-controls .control-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
        }
        
        #apply-chart-settings {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        #apply-chart-settings:hover {
            background-color: #45a049;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #1976d2;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .user-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .predictions-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>🎯 Personal Trading Dashboard</h1>
            <p>Your personalized AI-powered market predictions</p>
        </div>
        
        <div class="user-info">
            <div class="user-details">
                <div class="user-avatar">{{ user_config.first_name[0] if user_config.first_name else 'U' }}</div>
                <div>
                    <div class="user-name">{{ user_config.first_name }} {{ user_config.last_name }}</div>
                    <div style="color: #666; font-size: 0.9em;">{{ user_config.email }}</div>
                </div>
            </div>
            
            <div class="user-preferences">
                <div class="preference-item">
                    <div class="preference-label">Default Symbol</div>
                    <div class="preference-value">{{ user_config.default_company or 'AAPL' }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Timeframe</div>
                    <div class="preference-value">{{ user_config.default_timeframe or '1d' }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Predictions</div>
                    <div class="preference-value">{{ user_config.default_prediction_count or 10 }}</div>
                </div>
                <div class="preference-item">
                    <div class="preference-label">Model</div>
                    <div class="preference-value">{{ user_config.preferred_model or 'LSTM' }}</div>
                </div>
            </div>
        </div>
        
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="symbol">Stock Symbol:</label>
                    <select id="symbol">
                        <option value="AAPL" {{ 'selected' if user_config.default_company == 'AAPL' else '' }}>Apple (AAPL)</option>
                        <option value="MSFT" {{ 'selected' if user_config.default_company == 'MSFT' else '' }}>Microsoft (MSFT)</option>
                        <option value="GOOGL" {{ 'selected' if user_config.default_company == 'GOOGL' else '' }}>Google (GOOGL)</option>
                        <option value="AMZN" {{ 'selected' if user_config.default_company == 'AMZN' else '' }}>Amazon (AMZN)</option>
                        <option value="TSLA" {{ 'selected' if user_config.default_company == 'TSLA' else '' }}>Tesla (TSLA)</option>
                        <option value="META" {{ 'selected' if user_config.default_company == 'META' else '' }}>Meta (META)</option>
                        <option value="NVDA" {{ 'selected' if user_config.default_company == 'NVDA' else '' }}>NVIDIA (NVDA)</option>
                        <option value="NFLX" {{ 'selected' if user_config.default_company == 'NFLX' else '' }}>Netflix (NFLX)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="timeframe">Timeframe:</label>
                    <select id="timeframe">
                        <option value="1min" {{ 'selected' if user_config.default_timeframe == '1min' else '' }}>1 Minute</option>
                        <option value="5min" {{ 'selected' if user_config.default_timeframe == '5min' else '' }}>5 Minutes</option>
                        <option value="15min" {{ 'selected' if user_config.default_timeframe == '15min' else '' }}>15 Minutes</option>
                        <option value="30min" {{ 'selected' if user_config.default_timeframe == '30min' else '' }}>30 Minutes</option>
                        <option value="1h" {{ 'selected' if user_config.default_timeframe == '1h' else '' }}>1 Hour</option>
                        <option value="4h" {{ 'selected' if user_config.default_timeframe == '4h' else '' }}>4 Hours</option>
                        <option value="1d" {{ 'selected' if user_config.default_timeframe == '1d' else '' }}>1 Day</option>
                        <option value="1w" {{ 'selected' if user_config.default_timeframe == '1w' else '' }}>1 Week</option>
                        <option value="1mo" {{ 'selected' if user_config.default_timeframe == '1mo' else '' }}>1 Month</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="prediction_count">Number of Predictions:</label>
                    <input type="number" id="prediction_count" min="1" max="50" value="{{ user_config.default_prediction_count or 10 }}">
                </div>
                
                <div class="control-group">
                    <label for="model_type">ML Model:</label>
                    <select id="model_type">
                        <option value="LSTM" {{ 'selected' if user_config.preferred_model == 'LSTM' else '' }}>LSTM</option>
                        <option value="CNN" {{ 'selected' if user_config.preferred_model == 'CNN' else '' }}>CNN</option>
                        <option value="RNN" {{ 'selected' if user_config.preferred_model == 'RNN' else '' }}>RNN</option>
                        <option value="Hybrid" {{ 'selected' if user_config.preferred_model == 'Hybrid' else '' }}>Hybrid</option>
                        <option value="Statistical" {{ 'selected' if user_config.preferred_model == 'Statistical' else '' }}>Statistical</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="risk_level">Risk Level:</label>
                    <select id="risk_level">
                        <option value="conservative">Conservative</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="provider">Data Provider:</label>
                    <select id="provider">
                        <option value="finnhub" selected>Finnhub</option>
                        <option value="yahoo">Yahoo Finance</option>
                        <option value="alpha_vantage">Alpha Vantage</option>
                        <option value="polygon">Polygon</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="generatePrediction()">🔮 Generate New Prediction</button>
                <button class="btn btn-secondary" onclick="loadUserPredictions()">📊 Load My Predictions</button>
                <button class="btn btn-success" onclick="saveAsDefault()">💾 Save as Default</button>
                <button class="btn" style="background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);" onclick="fetchHistoricalData()">📈 View Historical Data</button>
            </div>
        </div>
        
        <!-- Separate Predicted Candles Section -->
        <div class="predicted-candles-section" style="padding: 30px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
                <h2 style="font-size: 1.8em; font-weight: 600; color: #333; margin: 0;">🔮 Predicted Candles (Next <span id="current-prediction-count">{{ user_config.default_prediction_count or 10 }}</span> Candles)</h2>
                <div class="prediction-controls" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="prediction-count-slider" style="font-weight: 600; color: #555;">Prediction Count:</label>
                        <input type="range" id="prediction-count-slider" min="1" max="50" value="{{ user_config.default_prediction_count or 10 }}" 
                               style="width: 120px;" oninput="updatePredictionCount(this.value)">
                        <span id="prediction-count-display" style="font-weight: bold; color: #667eea; min-width: 30px;">{{ user_config.default_prediction_count or 10 }}</span>
                    </div>
                    <button class="btn" onclick="generateSeparatePrediction()" style="font-size: 14px; padding: 8px 16px;">🎯 Generate Separate View</button>
                </div>
            </div>
            
            <div id="separate-predictions-chart" style="background: white; border-radius: 15px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; min-height: 400px;">
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.5;">📊</div>
                    <h3>Generate Predictions to View Separate Chart</h3>
                    <p>Use the controls above to generate predictions and view them in a dedicated chart.</p>
                </div>
            </div>
            
            <div class="prediction-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div class="detail-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;" id="predicted-symbol">-</div>
                    <div style="font-size: 0.9em; color: #666;">Symbol</div>
                </div>
                <div class="detail-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;" id="predicted-model">-</div>
                    <div style="font-size: 0.9em; color: #666;">Model Used</div>
                </div>
                <div class="detail-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;" id="predicted-confidence">-</div>
                    <div style="font-size: 0.9em; color: #666;">Confidence</div>
                </div>
                <div class="detail-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;" id="predicted-change">-</div>
                    <div style="font-size: 0.9em; color: #666;">Expected Change</div>
                </div>
                <div class="detail-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;" id="predicted-timeframe">-</div>
                    <div style="font-size: 0.9em; color: #666;">Timeframe</div>
                </div>
                <div class="detail-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;" id="generation-time">-</div>
                    <div style="font-size: 0.9em; color: #666;">Generated At</div>
                </div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <h3>📦 Export Predictions & Reports</h3>
            <div class="export-controls">
                <div class="export-form">
                    <h4>📊 Export Predictions</h4>
                    <div class="form-group">
                        <label for="export-symbol">Symbol:</label>
                        <select id="export-symbol">
                            <option value="AAPL">Apple (AAPL)</option>
                            <option value="MSFT">Microsoft (MSFT)</option>
                            <option value="GOOGL">Google (GOOGL)</option>
                            <option value="AMZN">Amazon (AMZN)</option>
                            <option value="TSLA">Tesla (TSLA)</option>
                            <option value="META">Meta (META)</option>
                            <option value="NVDA">NVIDIA (NVDA)</option>
                            <option value="NFLX">Netflix (NFLX)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-timeframe">Timeframe:</label>
                        <select id="export-timeframe">
                            <option value="1d">1 Day</option>
                            <option value="1h">1 Hour</option>
                            <option value="4h">4 Hours</option>
                            <option value="1w">1 Week</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-model">Model Type:</label>
                        <select id="export-model">
                            <option value="LSTM">LSTM</option>
                            <option value="CNN">CNN</option>
                            <option value="RNN">RNN</option>
                            <option value="Hybrid">Hybrid</option>
                            <option value="Statistical">Statistical</option>
                        </select>
                    </div>
                    <div class="export-buttons">
                        <button class="export-btn csv" onclick="exportPredictionsCSV()">
                            📄 Export CSV
                        </button>
                        <button class="export-btn pdf" onclick="exportPredictionsPDF()">
                            📋 Export PDF Report
                        </button>
                    </div>
                </div>
                
                <div class="export-form">
                    <h4>📈 Export Performance Metrics</h4>
                    <p style="color: #666; margin-bottom: 15px;">Export detailed model performance analysis and comparison reports.</p>
                    <div class="export-buttons">
                        <button class="export-btn csv" onclick="exportPerformanceCSV()">
                            📊 Performance CSV
                        </button>
                        <button class="export-btn pdf" onclick="exportPerformancePDF()">
                            📋 Performance Report
                        </button>
                    </div>
                </div>
                
                <div class="export-form">
                    <h4>📊 Export Historical Data</h4>
                    <div class="form-group">
                        <label for="export-historical-symbol">Symbol:</label>
                        <select id="export-historical-symbol">
                            <option value="AAPL">Apple (AAPL)</option>
                            <option value="MSFT">Microsoft (MSFT)</option>
                            <option value="GOOGL">Google (GOOGL)</option>
                            <option value="AMZN">Amazon (AMZN)</option>
                            <option value="TSLA">Tesla (TSLA)</option>
                            <option value="META">Meta (META)</option>
                            <option value="NVDA">NVIDIA (NVDA)</option>
                            <option value="NFLX">Netflix (NFLX)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-historical-timeframe">Timeframe:</label>
                        <select id="export-historical-timeframe">
                            <option value="1d">1 Day</option>
                            <option value="1h">1 Hour</option>
                            <option value="4h">4 Hours</option>
                            <option value="1w">1 Week</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-historical-period">Period:</label>
                        <select id="export-historical-period">
                            <option value="1mo">1 Month</option>
                            <option value="3mo">3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y">1 Year</option>
                            <option value="2y">2 Years</option>
                            <option value="5y">5 Years</option>
                        </select>
                    </div>
                    <div class="export-buttons">
                        <button class="export-btn csv" onclick="exportHistoricalDataCSV()">
                            📄 Export Historical CSV
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="export-stats" id="export-stats-section" style="display: none;">
                <h5>📁 Export Statistics</h5>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-exports">0</div>
                        <div class="stat-label">Total Files</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="csv-exports">0</div>
                        <div class="stat-label">CSV Files</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pdf-exports">0</div>
                        <div class="stat-label">PDF Files</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-size">0 MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Performance Comparison Section -->
        <div class="model-performance-section" style="padding: 30px; background: #f0f7ff; border-bottom: 1px solid #e0e0e0;">
            <h3 style="font-size: 1.8em; font-weight: 600; color: #333; margin-bottom: 20px;">🤖 Model Performance Comparison</h3>
            
            <div class="performance-table-container" style="background: white; border-radius: 15px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; text-align: center;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 12px; border: 1px solid #ddd;">Model Type</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">Accuracy</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">Precision</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">Recall</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">F1 Score</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">Training Time</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="model-performance-table">
                        <!-- Performance data will be loaded here -->
                        <tr>
                            <td colspan="7" style="padding: 30px; text-align: center; color: #666;">
                                <div style="margin-bottom: 15px;">⏳ Loading model performance data...</div>
                                <div class="loading-spinner" style="margin: 0 auto;"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="performance-chart-container" style="background: white; border-radius: 15px; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px; color: #495057;">Performance Comparison Chart</h4>
                <div id="model-performance-chart" style="height: 300px;"></div>
            </div>
            
            <div class="performance-actions" style="display: flex; gap: 15px; justify-content: flex-end;">
                <button class="btn" onclick="refreshModelPerformance()" style="background: #28a745; color: white;">🔄 Refresh Data</button>
                <button class="btn" onclick="exportPerformancePDF()" style="background: #dc3545; color: white;">📋 Export Report</button>
            </div>
        </div>
        
        <div class="predictions-section">
            <div class="predictions-header">
                <h2 class="predictions-title">📈 All My Predictions</h2>
                <div class="predictions-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-predictions">0</div>
                        <div class="stat-label">Total Predictions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-confidence">0%</div>
                        <div class="stat-label">Avg Confidence</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-symbols">0</div>
                        <div class="stat-label">Active Symbols</div>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>🔄 Generating personalized predictions...</p>
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div id="empty-state" class="empty-state">
                <div class="empty-state-icon">📈</div>
                <h3>No Predictions Yet</h3>
                <p>Generate your first personalized prediction to get started!</p>
            </div>
            
            <div id="predictions-grid" class="predictions-grid"></div>
        </div>
    </div>
    
    <script>
        let userPredictions = [];
        
        function generateSubUsers() {
            const count = document.getElementById('subUserCount').value;
            const container = document.getElementById('subUsersContainer');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                container.innerHTML += `
                    <div class="sub-user-config card mb-3">
                        <div class="card-body">
                            <h6>Sub-User ${i + 1}</h6>
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Stock Symbol</label>
                                    <select class="form-select symbol-select">
                                        <option value="AAPL">Apple (AAPL)</option>
                                        <option value="GOOGL">Google (GOOGL)</option>
                                        <option value="MSFT">Microsoft (MSFT)</option>
                                        <option value="TSLA">Tesla (TSLA)</option>
                                        <option value="AMZN">Amazon (AMZN)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Timeframe</label>
                                    <select class="form-select timeframe-select">
                                        <option value="1m">1 Minute</option>
                                        <option value="5m">5 Minutes</option>
                                        <option value="15m">15 Minutes</option>
                                        <option value="1h">1 Hour</option>
                                        <option value="1d">1 Day</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">ML Model</label>
                                    <select class="form-select model-select">
                                        <option value="lstm">LSTM</option>
                                        <option value="cnn">CNN</option>
                                        <option value="rnn">RNN</option>
                                        <option value="hybrid">Hybrid</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Future Candles</label>
                                    <input type="number" class="form-control prediction-count" min="1" max="50" value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function startPredictions() {
            const subUsers = document.querySelectorAll('.sub-user-config');
            const predictionsGrid = document.getElementById('predictionsGrid');
            predictionsGrid.innerHTML = '';

            subUsers.forEach((subUser, index) => {
                const symbol = subUser.querySelector('.symbol-select').value;
                const timeframe = subUser.querySelector('.timeframe-select').value;
                const model = subUser.querySelector('.model-select').value;
                const predictionCount = subUser.querySelector('.prediction-count').value;

                // Add a chart container for this sub-user
                const chartContainer = document.createElement('div');
                chartContainer.className = 'col-md-6 mb-4';
                chartContainer.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">${symbol} - ${timeframe} Predictions</h6>
                        </div>
                        <div class="card-body">
                            <div id="chart-${index}" style="height: 300px;"></div>
                        </div>
                    </div>
                `;
                predictionsGrid.appendChild(chartContainer);

                // Initialize chart and fetch predictions
                initializeChart(index, symbol, timeframe, model, predictionCount);
            });
        }

        function initializeChart(index, symbol, timeframe, model, predictionCount) {
            // Implement chart initialization and data fetching
            // This will connect to your backend API to get real-time data and predictions
        }
        
        function generateSubUsers() {
            const count = document.getElementById('subUserCount').value;
            const container = document.getElementById('subUsersContainer');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                container.innerHTML += `
                    <div class="sub-user-config card mb-3">
                        <div class="card-body">
                            <h6>Sub-User ${i + 1}</h6>
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Stock Symbol</label>
                                    <select class="form-select symbol-select">
                                        <option value="AAPL">Apple (AAPL)</option>
                                        <option value="GOOGL">Google (GOOGL)</option>
                                        <option value="MSFT">Microsoft (MSFT)</option>
                                        <option value="TSLA">Tesla (TSLA)</option>
                                        <option value="AMZN">Amazon (AMZN)</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Timeframe</label>
                                    <select class="form-select timeframe-select">
                                        <option value="1m">1 Minute</option>
                                        <option value="5m">5 Minutes</option>
                                        <option value="15m">15 Minutes</option>
                                        <option value="1h">1 Hour</option>
                                        <option value="1d">1 Day</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">ML Model</label>
                                    <select class="form-select model-select">
                                        <option value="lstm">LSTM</option>
                                        <option value="cnn">CNN</option>
                                        <option value="rnn">RNN</option>
                                        <option value="hybrid">Hybrid</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Future Candles</label>
                                    <input type="number" class="form-control prediction-count" min="1" max="50" value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function startPredictions() {
            const subUsers = document.querySelectorAll('.sub-user-config');
            const predictionsGrid = document.getElementById('predictionsGrid');
            predictionsGrid.innerHTML = '';

            subUsers.forEach((subUser, index) => {
                const symbol = subUser.querySelector('.symbol-select').value;
                const timeframe = subUser.querySelector('.timeframe-select').value;
                const model = subUser.querySelector('.model-select').value;
                const predictionCount = subUser.querySelector('.prediction-count').value;

                // Add a chart container for this sub-user
                const chartContainer = document.createElement('div');
                chartContainer.className = 'col-md-6 mb-4';
                chartContainer.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">${symbol} - ${timeframe} Predictions</h6>
                        </div>
                        <div class="card-body">
                            <div id="chart-${index}" style="height: 300px;"></div>
                        </div>
                    </div>
                `;
                predictionsGrid.appendChild(chartContainer);

                // Initialize chart and fetch predictions
                initializeChart(index, symbol, timeframe, model, predictionCount);
            });
        }

        function initializeChart(index, symbol, timeframe, model, predictionCount) {
            // Implement chart initialization and data fetching
            // This will connect to your backend API to get real-time data and predictions
        }
        let currentSeparatePrediction = null;
        
        // Load user predictions on page load
        window.addEventListener('load', function() {
            loadUserPredictions();
            loadUserStats();
        });

        // Load user statistics
        async function loadUserStats() {
            try {
                const response = await fetch('/api/user/stats');
                const data = await response.json();
                
                if (data.success) {
                    updateStatistics(data.stats);
                }
            } catch (error) {
                console.error('Failed to load user statistics:', error);
            }
        }

        // Update statistics display
        function updateStatistics(stats) {
            document.getElementById('total-users').textContent = stats.total_users;
            document.getElementById('active-users').textContent = stats.active_users;
        }

        // Generate predictions
        document.getElementById('generate-predictions').addEventListener('click', async function() {
            const symbol = document.getElementById('symbol-select').value;
            const timeframe = document.getElementById('timeframe-select').value;
            const model = document.getElementById('model-select').value;
            const predictionCount = document.getElementById('prediction-count').value;

            try {
                const loadingDiv = document.getElementById('loading');
                const errorDiv = document.getElementById('error');
                loadingDiv.style.display = 'flex';
                errorDiv.style.display = 'none';

                const response = await fetch('/api/predictions/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        model_type: model,
                        prediction_count: parseInt(predictionCount)
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate predictions');
                }

                // Update predictions display
                loadUserPredictions();
                
                // Update user statistics
                loadUserStats();

            } catch (error) {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
                console.error('Prediction generation error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        
        function updatePredictionCount(value) {
            document.getElementById('prediction-count-display').textContent = value;
            document.getElementById('current-prediction-count').textContent = value;
            document.getElementById('prediction_count').value = value;
        }
        
        async function generateSeparatePrediction() {
            const loading = document.createElement('div');
            loading.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #666;">
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <h3>🔄 Generating Separate Prediction...</h3>
                    <p>Creating your personalized ${document.getElementById('prediction-count-slider').value} candle forecast...</p>
                </div>
            `;
            
            const chartContainer = document.getElementById('separate-predictions-chart');
            chartContainer.innerHTML = '';
            chartContainer.appendChild(loading);
            
            try {
                const predictionCount = document.getElementById('prediction-count-slider').value;
                const symbol = document.getElementById('symbol').value;
                const timeframe = document.getElementById('timeframe').value;
                const modelType = document.getElementById('model_type').value;
                const riskLevel = document.getElementById('risk_level').value;
                const provider = document.getElementById('provider').value;
                
                const response = await fetch('/api/chart/candlestick-with-predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        prediction_count: parseInt(predictionCount),
                        model_type: modelType,
                        risk_level: riskLevel,
                        provider: provider,
                        include_volume: false,
                        include_indicators: true,
                        period: '1y'
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate separate prediction');
                }
                
                currentSeparatePrediction = data;
                renderSeparatePredictionChart(data);
                updatePredictionDetails(data);
                
            } catch (err) {
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #721c24; background: #f8d7da; border-radius: 10px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">❌</div>
                        <h3>Error Generating Prediction</h3>
                        <p>${err.message}</p>
                        <button class="btn" onclick="generateSeparatePrediction()" style="margin-top: 15px;">🔄 Try Again</button>
                    </div>
                `;
                console.error('Separate prediction generation error:', err);
            }
        }
        
        function renderSeparatePredictionChart(data) {
            const chartContainer = document.getElementById('separate-predictions-chart');
            
            // Create data source indicator
            const dataSource = data.chart_config.data_source || 'unknown';
            const isSynthetic = dataSource.includes('synthetic');
            const dataSourceInfo = isSynthetic ? 
                '<div class="data-source-warning">⚠️ Using synthetic data due to insufficient real market data</div>' : 
                `<div class="data-source-info">📊 Data source: ${dataSource}</div>`;
            
            chartContainer.innerHTML = `
                ${dataSourceInfo}
                <div id="separate-chart-plot" style="width: 100%; height: 400px;"></div>
                <div class="prediction-info">
                    <div class="info-item">🎯 Predictions: ${data.prediction_data.timestamps.length}</div>
                    <div class="info-item">🤖 Model: ${data.chart_config.model_type}</div>
                    <div class="info-item">📈 Avg Confidence: ${(data.data_summary.avg_confidence * 100).toFixed(1)}%</div>
                    <div class="info-item">💰 Price Range: $${data.data_summary.predicted_price_range.min.toFixed(2)} - $${data.data_summary.predicted_price_range.max.toFixed(2)}</div>
                </div>
            `;
            
            // Access prediction data from the correct property in the API response
            const predictionData = data.prediction_data;
            const timestamps = predictionData.timestamps;
            const ohlc = predictionData.ohlc;
            
            const trace = {
                x: timestamps,
                open: ohlc.open,
                high: ohlc.high,
                low: ohlc.low,
                close: ohlc.close,
                type: 'candlestick',
                name: `${data.chart_config.symbol} Predictions`,
                increasing: {line: {color: isSynthetic ? '#ffa500' : '#00ff88', width: 2}},
                decreasing: {line: {color: isSynthetic ? '#ff6b35' : '#ff4444', width: 2}}
            };
            
            // Update title to include data source information
            const titleText = isSynthetic ? 
                `🔮 ${data.chart_config.symbol} - Next ${timestamps.length} Predicted Candles (${data.chart_config.model_type} Model) - Synthetic Data` :
                `🔮 ${data.chart_config.symbol} - Next ${timestamps.length} Predicted Candles (${data.chart_config.model_type} Model)`;
            
            const layout = {
                title: {
                    text: titleText,
                    font: {size: 18, color: isSynthetic ? '#ff6b35' : '#333'}
                },
                xaxis: {
                    title: 'Time Period',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    tickangle: -45
                },
                yaxis: {
                    title: 'Price ($)',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                showlegend: false,
                margin: {l: 60, r: 40, t: 80, b: 80},
                plot_bgcolor: isSynthetic ? '#fff8f0' : '#fafafa',
                paper_bgcolor: 'white',
                font: {family: 'Segoe UI, sans-serif'}
            };
            
            const config = {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                responsive: true
            };
            
            Plotly.newPlot('separate-chart-plot', [trace], layout, config);
        }
        
        function updatePredictionDetails(data) {
            const predictionData = data.prediction_data;
            const ohlc = predictionData.ohlc;
            const firstClose = ohlc.close[0];
            const lastClose = ohlc.close[ohlc.close.length - 1];
            const priceChange = lastClose - firstClose;
            const changePercent = ((priceChange / firstClose) * 100).toFixed(2);
            
            document.getElementById('predicted-symbol').textContent = data.chart_config.symbol;
            document.getElementById('predicted-model').textContent = data.chart_config.model_type;
            document.getElementById('predicted-confidence').textContent = `${(data.data_summary.avg_confidence * 100).toFixed(1)}%`;
            document.getElementById('predicted-change').textContent = `${changePercent > 0 ? '+' : ''}${changePercent}%`;
            document.getElementById('predicted-timeframe').textContent = data.chart_config.timeframe;
            document.getElementById('generation-time').textContent = new Date().toLocaleTimeString();
            
            // Color code the change
            const changeElement = document.getElementById('predicted-change');
            changeElement.style.color = changePercent >= 0 ? '#00ff88' : '#ff4444';
        }
        
        async function generatePrediction() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            
            try {
                const formData = new FormData();
                formData.append('symbol', document.getElementById('symbol').value);
                formData.append('timeframe', document.getElementById('timeframe').value);
                formData.append('prediction_count', document.getElementById('prediction_count').value);
                formData.append('model_type', document.getElementById('model_type').value);
                formData.append('risk_level', document.getElementById('risk_level').value);
                formData.append('provider', document.getElementById('provider').value);
                
                const response = await fetch('/api/predictions/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to generate prediction');
                }
                
                // Reload predictions to show the new one
                await loadUserPredictions();
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = `Error: ${err.message}`;
                console.error('Prediction generation error:', err);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function loadUserPredictions() {
            try {
                const response = await fetch('/api/user/predictions');
                const data = await response.json();
                
                if (data.success) {
                    userPredictions = data.predictions;
                    displayPredictions(userPredictions);
                    updateStats(userPredictions);
                } else {
                    throw new Error(data.error || 'Failed to load predictions');
                }
                
            } catch (err) {
                console.error('Error loading predictions:', err);
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${err.message}`;
            }
        }
        
        function displayPredictions(predictions) {
            const grid = document.getElementById('predictions-grid');
            const emptyState = document.getElementById('empty-state');
            
            if (!predictions || predictions.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            grid.innerHTML = predictions.map(prediction => {
                const predData = prediction.predictions_data;
                const latestPrediction = predData[predData.length - 1];
                const firstPrediction = predData[0];
                const priceChange = latestPrediction.predicted_close - firstPrediction.predicted_close;
                const changePercent = ((priceChange / firstPrediction.predicted_close) * 100).toFixed(2);
                
                return `
                    <div class="prediction-card">
                        <div class="prediction-header">
                            <div class="prediction-symbol">${prediction.symbol}</div>
                            <div class="prediction-meta">
                                ${prediction.model_type} • ${prediction.timeframe} • ${prediction.prediction_count} candles
                            </div>
                        </div>
                        <div class="prediction-content">
                            <div class="prediction-chart" id="chart-${prediction.id}"></div>
                            <div class="prediction-summary">
                                <div class="summary-item">
                                    <div class="summary-value">$${firstPrediction.predicted_close.toFixed(2)}</div>
                                    <div class="summary-label">Starting Price</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">$${latestPrediction.predicted_close.toFixed(2)}</div>
                                    <div class="summary-label">Final Price</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${changePercent}%</div>
                                    <div class="summary-label">Expected Change</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${(prediction.confidence_score * 100).toFixed(1)}%</div>
                                    <div class="summary-label">Confidence</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render charts for each prediction
            predictions.forEach(prediction => {
                renderPredictionChart(prediction);
            });
        }
        
        function renderPredictionChart(prediction) {
            const predData = prediction.predictions_data;
            
            const trace = {
                x: predData.map(p => p.timestamp),
                open: predData.map(p => p.predicted_open),
                high: predData.map(p => p.predicted_high),
                low: predData.map(p => p.predicted_low),
                close: predData.map(p => p.predicted_close),
                type: 'candlestick',
                name: `${prediction.symbol} Predictions`,
                increasing: {line: {color: '#00ff88'}},
                decreasing: {line: {color: '#ff4444'}}
            };
            
            const layout = {
                title: {
                    text: `${prediction.symbol} - ${prediction.prediction_count} Candle Forecast`,
                    font: {size: 14}
                },
                xaxis: {
                    title: 'Time',
                    showgrid: false
                },
                yaxis: {
                    title: 'Price ($)',
                    showgrid: true,
                    gridcolor: '#f0f0f0'
                },
                showlegend: false,
                margin: {l: 50, r: 20, t: 40, b: 40},
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            Plotly.newPlot(`chart-${prediction.id}`, [trace], layout, config);
        }
        
        function updateStats(predictions) {
            const totalPredictions = predictions.length;
            const avgConfidence = predictions.length > 0 
                ? (predictions.reduce((sum, p) => sum + (p.confidence_score || 0), 0) / predictions.length * 100).toFixed(1)
                : 0;
            const activeSymbols = new Set(predictions.map(p => p.symbol)).size;
            
            document.getElementById('total-predictions').textContent = totalPredictions;
            document.getElementById('avg-confidence').textContent = `${avgConfidence}%`;
            document.getElementById('active-symbols').textContent = activeSymbols;
        }
        
        async function saveAsDefault() {
            try {
                const requestData = {
                    default_company: document.getElementById('symbol').value,
                    default_timeframe: document.getElementById('timeframe').value,
                    default_prediction_count: document.getElementById('prediction_count').value,
                    preferred_model: document.getElementById('model_type').value,
                    preferred_provider: document.getElementById('provider').value
                };
                
                const response = await fetch('/api/user/update-preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Default preferences saved successfully!');
                    // Reload page to reflect changes
                    window.location.reload();
                } else {
                    throw new Error(data.error || 'Failed to save preferences');
                }
                
            } catch (err) {
                alert(`❌ Error saving preferences: ${err.message}`);
                console.error('Error saving preferences:', err);
            }
        }
        
        // Function to fetch historical data and display it
        async function fetchHistoricalData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            
            try {
                const requestData = {
                    symbol: document.getElementById('symbol').value,
                    timeframe: document.getElementById('timeframe').value,
                    period: '1y', // Default to 1 year of data
                    provider: document.getElementById('provider').value,
                    include_indicators: true
                };
                
                const response = await fetch('/api/candlestick-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch historical data');
                }
                
                // Display the historical data chart
                displayHistoricalChart(data);
                
            } catch (err) {
                error.style.display = 'block';
                error.textContent = `Error: ${err.message}`;
                console.error('Historical data fetch error:', err);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Function to display historical chart with enhanced visualization options
        function displayHistoricalChart(data) {
            const chartData = data.candlestick_data;
            const chartContainer = document.getElementById('separate-predictions-chart');
            
            // Add chart controls if they don't exist
            if (!document.getElementById('chart-controls')) {
                const controlsDiv = document.createElement('div');
                controlsDiv.id = 'chart-controls';
                controlsDiv.className = 'chart-controls';
                controlsDiv.innerHTML = `
                    <div class="control-group">
                        <label>Chart Type:</label>
                        <select id="chart-type">
                            <option value="candlestick" selected>Candlestick</option>
                            <option value="ohlc">OHLC</option>
                            <option value="line">Line</option>
                            <option value="area">Area</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Indicators:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="show-sma" checked> SMA</label>
                            <label><input type="checkbox" id="show-ema"> EMA</label>
                            <label><input type="checkbox" id="show-bollinger"> Bollinger Bands</label>
                            <label><input type="checkbox" id="show-volume" checked> Volume</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Time Period:</label>
                        <select id="time-period">
                            <option value="1mo">1 Month</option>
                            <option value="3mo">3 Months</option>
                            <option value="6mo">6 Months</option>
                            <option value="1y" selected>1 Year</option>
                            <option value="2y">2 Years</option>
                            <option value="5y">5 Years</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Theme:</label>
                        <select id="chart-theme">
                            <option value="light" selected>Light</option>
                            <option value="dark">Dark</option>
                            <option value="finance">Finance</option>
                        </select>
                    </div>
                    <button id="apply-chart-settings" class="btn">Apply Settings</button>
                `;
                
                // Insert controls before the chart
                chartContainer.parentNode.insertBefore(controlsDiv, chartContainer);
                
                // Add event listener for the apply button
                document.getElementById('apply-chart-settings').addEventListener('click', function() {
                    updateChartWithSettings(data);
                });
            }
            
            // Initial chart render with default settings
            updateChartWithSettings(data);
        }
        
        // Function to update chart based on selected settings
        function updateChartWithSettings(data) {
            const chartData = data.candlestick_data;
            const chartType = document.getElementById('chart-type').value;
            const showSMA = document.getElementById('show-sma').checked;
            const showEMA = document.getElementById('show-ema').checked;
            const showBollinger = document.getElementById('show-bollinger').checked;
            const showVolume = document.getElementById('show-volume').checked;
            const chartTheme = document.getElementById('chart-theme').value;
            
            // Prepare traces array
            const traces = [];
            
            // Set theme colors based on selection
            let colors = {
                increasing: '#00ff88',
                decreasing: '#ff4444',
                background: '#fafafa',
                paper: 'white',
                grid: '#f0f0f0',
                text: '#333',
                volume: {
                    up: 'rgba(0, 255, 136, 0.3)',
                    down: 'rgba(255, 68, 68, 0.3)'
                }
            };
            
            if (chartTheme === 'dark') {
                colors = {
                    increasing: '#00ff88',
                    decreasing: '#ff4444',
                    background: '#1e1e1e',
                    paper: '#121212',
                    grid: '#333',
                    text: '#f0f0f0',
                    volume: {
                        up: 'rgba(0, 255, 136, 0.3)',
                        down: 'rgba(255, 68, 68, 0.3)'
                    }
                };
            } else if (chartTheme === 'finance') {
                colors = {
                    increasing: '#26a69a',
                    decreasing: '#ef5350',
                    background: '#263238',
                    paper: '#1c2a33',
                    grid: '#37474f',
                    text: '#eceff1',
                    volume: {
                        up: 'rgba(38, 166, 154, 0.3)',
                        down: 'rgba(239, 83, 80, 0.3)'
                    }
                };
            }
            
            // Create price trace based on chart type
            let priceTrace;
            
            if (chartType === 'candlestick') {
                priceTrace = {
                    x: chartData.map(d => d.timestamp),
                    open: chartData.map(d => d.open),
                    high: chartData.map(d => d.high),
                    low: chartData.map(d => d.low),
                    close: chartData.map(d => d.close),
                    type: 'candlestick',
                    name: `${data.symbol} Price`,
                    increasing: {line: {color: colors.increasing}},
                    decreasing: {line: {color: colors.decreasing}}
                };
            } else if (chartType === 'ohlc') {
                priceTrace = {
                    x: chartData.map(d => d.timestamp),
                    open: chartData.map(d => d.open),
                    high: chartData.map(d => d.high),
                    low: chartData.map(d => d.low),
                    close: chartData.map(d => d.close),
                    type: 'ohlc',
                    name: `${data.symbol} Price`,
                    increasing: {line: {color: colors.increasing}},
                    decreasing: {line: {color: colors.decreasing}}
                };
            } else if (chartType === 'line') {
                priceTrace = {
                    x: chartData.map(d => d.timestamp),
                    y: chartData.map(d => d.close),
                    type: 'scatter',
                    mode: 'lines',
                    name: `${data.symbol} Close Price`,
                    line: {
                        color: '#2196F3',
                        width: 2
                    }
                };
            } else if (chartType === 'area') {
                priceTrace = {
                    x: chartData.map(d => d.timestamp),
                    y: chartData.map(d => d.close),
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    name: `${data.symbol} Close Price`,
                    line: {
                        color: '#2196F3',
                        width: 2
                    },
                    fillcolor: 'rgba(33, 150, 243, 0.2)'
                };
            }
            
            traces.push(priceTrace);
            
            // Add SMA indicator if selected
            if (showSMA) {
                const period = 20; // 20-day SMA
                const smaData = calculateSMA(chartData.map(d => d.close), period);
                
                const smaTrace = {
                    x: chartData.map(d => d.timestamp).slice(period - 1),
                    y: smaData,
                    type: 'scatter',
                    mode: 'lines',
                    name: `SMA (${period})`,
                    line: {
                        color: '#FF9800',
                        width: 2
                    }
                };
                
                traces.push(smaTrace);
            }
            
            // Add EMA indicator if selected
            if (showEMA) {
                const period = 20; // 20-day EMA
                const emaData = calculateEMA(chartData.map(d => d.close), period);
                
                const emaTrace = {
                    x: chartData.map(d => d.timestamp).slice(period - 1),
                    y: emaData,
                    type: 'scatter',
                    mode: 'lines',
                    name: `EMA (${period})`,
                    line: {
                        color: '#9C27B0',
                        width: 2
                    }
                };
                
                traces.push(emaTrace);
            }
            
            // Add Bollinger Bands if selected
            if (showBollinger) {
                const period = 20;
                const stdDev = 2;
                const { upper, middle, lower } = calculateBollingerBands(chartData.map(d => d.close), period, stdDev);
                
                const upperTrace = {
                    x: chartData.map(d => d.timestamp).slice(period - 1),
                    y: upper,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Upper Band',
                    line: {
                        color: '#E91E63',
                        width: 1,
                        dash: 'dash'
                    }
                };
                
                const middleTrace = {
                    x: chartData.map(d => d.timestamp).slice(period - 1),
                    y: middle,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Middle Band',
                    line: {
                        color: '#E91E63',
                        width: 1
                    }
                };
                
                const lowerTrace = {
                    x: chartData.map(d => d.timestamp).slice(period - 1),
                    y: lower,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Lower Band',
                    line: {
                        color: '#E91E63',
                        width: 1,
                        dash: 'dash'
                    },
                    fill: 'tonexty',
                    fillcolor: 'rgba(233, 30, 99, 0.05)'
                };
                
                traces.push(upperTrace, middleTrace, lowerTrace);
            }
            
            // Create layout
            const layout = {
                title: {
                    text: `${data.symbol} Historical Data (${document.getElementById('provider').value})`,
                    font: {size: 16, color: colors.text}
                },
                xaxis: {
                    title: 'Date',
                    rangeslider: {visible: false},
                    gridcolor: colors.grid,
                    color: colors.text
                },
                yaxis: {
                    title: 'Price ($)',
                    domain: showVolume ? [0.3, 1] : [0, 1],
                    gridcolor: colors.grid,
                    color: colors.text
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: 1.1,
                    font: {color: colors.text}
                },
                margin: {l: 50, r: 20, t: 50, b: 40},
                plot_bgcolor: colors.background,
                paper_bgcolor: colors.paper
            };
            
            // Add volume if selected
            if (showVolume) {
                const volumeTrace = {
                    x: chartData.map(d => d.timestamp),
                    y: chartData.map(d => d.volume),
                    type: 'bar',
                    name: 'Volume',
                    marker: {
                        color: chartData.map(d => d.close > d.open ? colors.volume.up : colors.volume.down)
                    },
                    yaxis: 'y2'
                };
                
                traces.push(volumeTrace);
                
                // Add volume axis
                layout.yaxis2 = {
                    title: 'Volume',
                    domain: [0, 0.2],
                    gridcolor: colors.grid,
                    color: colors.text
                };
                
                layout.grid = {rows: 2, columns: 1, pattern: 'independent'};
            }
            
            // Create config
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };
            
            // Create the plot
            Plotly.newPlot('separate-predictions-chart', traces, layout, config);
        }
        
        // Helper function to calculate Simple Moving Average (SMA)
        function calculateSMA(data, period) {
            const sma = [];
            
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - (period - 1), i + 1).reduce((a, b) => a + b, 0);
                sma.push(sum / period);
            }
            
            return sma;
        }
        
        // Helper function to calculate Exponential Moving Average (EMA)
        function calculateEMA(data, period) {
            const ema = [];
            const multiplier = 2 / (period + 1);
            
            // Start with SMA for the first EMA value
            const firstSMA = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
            ema.push(firstSMA);
            
            // Calculate EMA for the rest of the data
            for (let i = period; i < data.length; i++) {
                const currentEMA = (data[i] - ema[ema.length - 1]) * multiplier + ema[ema.length - 1];
                ema.push(currentEMA);
            }
            
            return ema;
        }
        
        // Helper function to calculate Bollinger Bands
        function calculateBollingerBands(data, period, stdDev) {
            const middle = calculateSMA(data, period);
            const upper = [];
            const lower = [];
            
            for (let i = period - 1; i < data.length; i++) {
                const slice = data.slice(i - (period - 1), i + 1);
                const avg = middle[i - (period - 1)];
                
                // Calculate standard deviation
                const squaredDiffs = slice.map(value => Math.pow(value - avg, 2));
                const variance = squaredDiffs.reduce((a, b) => a + b, 0) / period;
                const sd = Math.sqrt(variance);
                
                upper.push(avg + (sd * stdDev));
                lower.push(avg - (sd * stdDev));
            }
            
            return { upper, middle, lower };
        }
        
        // Export Functions
        async function exportPredictionsCSV() {
            try {
                const symbol = document.getElementById('export-symbol').value;
                const timeframe = document.getElementById('export-timeframe').value;
                const modelType = document.getElementById('export-model').value;
                
                const formData = new FormData();
                if (symbol) formData.append('symbol', symbol);
                if (timeframe) formData.append('timeframe', timeframe);
                if (modelType) formData.append('model_type', modelType);
                
                const response = await fetch('/api/export/predictions/csv', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `predictions_${symbol || 'all'}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                updateExportStats();
                alert('✅ CSV export completed successfully!');
                
            } catch (error) {
                alert(`❌ Export failed: ${error.message}`);
                console.error('Export error:', error);
            }
        }
        
        async function exportPredictionsPDF() {
            try {
                const symbol = document.getElementById('export-symbol').value;
                const timeframe = document.getElementById('export-timeframe').value;
                const modelType = document.getElementById('export-model').value;
                const includeCharts = document.getElementById('include-charts').checked;
                const includePerformance = document.getElementById('include-performance').checked;
                
                const formData = new FormData();
                if (symbol) formData.append('symbol', symbol);
                if (timeframe) formData.append('timeframe', timeframe);
                if (modelType) formData.append('model_type', modelType);
                formData.append('include_chart', includeCharts);
                formData.append('include_performance', includePerformance);
                
                const response = await fetch('/api/export/predictions/pdf', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `predictions_report_${symbol || 'all'}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                updateExportStats();
                alert('✅ PDF export completed successfully!');
                
            } catch (error) {
                alert(`❌ Export failed: ${error.message}`);
                console.error('Export error:', error);
            }
        }
        
        async function exportPerformanceCSV() {
            try {
                const response = await fetch('/api/export/performance/csv', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `model_performance_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                updateExportStats();
                alert('✅ Performance CSV export completed successfully!');
                
            } catch (error) {
                alert(`❌ Export failed: ${error.message}`);
                console.error('Export error:', error);
            }
        }
        
        async function exportPerformancePDF() {
            try {
                const response = await fetch('/api/export/performance/pdf', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `performance_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                updateExportStats();
                alert('✅ Performance PDF export completed successfully!');
                
            } catch (error) {
                alert(`❌ Export failed: ${error.message}`);
                console.error('Export error:', error);
            }
        }
        
        async function updateExportStats() {
            try {
                const response = await fetch('/api/export/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-files').textContent = data.stats.total_files;
                    document.getElementById('csv-files').textContent = data.stats.csv_files;
                    document.getElementById('pdf-files').textContent = data.stats.pdf_files;
                    document.getElementById('total-size').textContent = data.stats.total_size;
                }
            } catch (error) {
                console.error('Failed to update export stats:', error);
            }
        }
        
        async function exportHistoricalDataCSV() {
            try {
                const symbol = document.getElementById('export-historical-symbol').value;
                const timeframe = document.getElementById('export-historical-timeframe').value;
                const period = document.getElementById('export-historical-period').value;
                
                // Create form data
                const formData = new FormData();
                formData.append('symbol', symbol);
                formData.append('timeframe', timeframe);
                formData.append('period', period);
                formData.append('provider', 'yahoo_finance'); // Default provider
                
                // Show loading indicator
                const originalButtonText = event.target.innerHTML;
                event.target.innerHTML = '⏳ Exporting...';
                event.target.disabled = true;
                
                const response = await fetch('/api/export/historical/csv', {
                    method: 'POST',
                    body: formData
                });
                
                // Reset button
                event.target.innerHTML = originalButtonText;
                event.target.disabled = false;
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `historical_data_${symbol}_${timeframe}_${period}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                updateExportStats();
                alert('✅ Historical data CSV export completed successfully!');
                
            } catch (error) {
                alert(`❌ Export failed: ${error.message}`);
                console.error('Export error:', error);
                
                // Reset button if error occurs
                if (event.target) {
                    event.target.innerHTML = '📄 Export Historical CSV';
                    event.target.disabled = false;
                }
            }
        }
        
        // Load export stats and model performance on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateExportStats();
            loadModelPerformance();
        });
        
        // Model Performance Functions
        async function loadModelPerformance() {
            try {
                const tableBody = document.getElementById('model-performance-table');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 30px; text-align: center; color: #666;">
                            <div style="margin-bottom: 15px;">⏳ Loading model performance data...</div>
                            <div class="loading-spinner" style="margin: 0 auto;"></div>
                        </td>
                    </tr>
                `;
                
                const response = await fetch('/api/models/performance');
                
                if (!response.ok) {
                    throw new Error('Failed to load model performance data');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load model performance data');
                }
                
                // Render table
                renderModelPerformanceTable(data.models);
                
                // Render chart
                renderModelPerformanceChart(data.models);
                
            } catch (error) {
                const tableBody = document.getElementById('model-performance-table');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 30px; text-align: center; color: #721c24;">
                            <div style="font-size: 2em; margin-bottom: 10px;">❌</div>
                            <div>Error loading model performance data</div>
                            <div style="font-size: 0.9em; margin-top: 10px; color: #666;">${error.message}</div>
                            <button class="btn" onclick="refreshModelPerformance()" style="margin-top: 15px; background: #28a745; color: white;">🔄 Try Again</button>
                        </td>
                    </tr>
                `;
                console.error('Model performance loading error:', error);
            }
        }
        
        function renderModelPerformanceTable(models) {
            const tableBody = document.getElementById('model-performance-table');
            
            if (!models || models.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 30px; text-align: center; color: #666;">
                            <div style="font-size: 2em; margin-bottom: 10px;">📊</div>
                            <div>No model performance data available</div>
                            <div style="font-size: 0.9em; margin-top: 10px; color: #666;">Generate predictions to collect performance metrics</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = '';
            
            models.forEach(model => {
                const row = document.createElement('tr');
                
                // Format training time
                const trainingTime = model.training_time < 60 ? 
                    `${model.training_time.toFixed(1)}s` : 
                    `${(model.training_time / 60).toFixed(1)}m`;
                
                // Determine color based on accuracy
                const accuracyColor = model.accuracy >= 0.7 ? '#28a745' : 
                                     model.accuracy >= 0.5 ? '#ffc107' : '#dc3545';
                
                row.innerHTML = `
                    <td style="padding: 12px; border: 1px solid #ddd;">${model.model_type}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; justify-content: center;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${accuracyColor}; color: white; font-weight: bold; margin-right: 10px;">
                                ${(model.accuracy * 100).toFixed(0)}%
                            </div>
                            <div style="width: 100px; height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden;">
                                <div style="height: 100%; width: ${model.accuracy * 100}%; background: ${accuracyColor};"></div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${(model.precision * 100).toFixed(1)}%</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${(model.recall * 100).toFixed(1)}%</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${(model.f1_score * 100).toFixed(1)}%</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">${trainingTime}</td>
                    <td style="padding: 12px; border: 1px solid #ddd;">
                        <button class="btn" onclick="selectModel('${model.model_type}')" style="background: #667eea; color: white; padding: 5px 10px; font-size: 0.9em;">
                            Use Model
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function renderModelPerformanceChart(models) {
            if (!models || models.length === 0) {
                document.getElementById('model-performance-chart').innerHTML = `
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666; text-align: center;">
                        <div>
                            <div style="font-size: 2em; margin-bottom: 10px;">📊</div>
                            <div>No model performance data available</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const modelTypes = models.map(model => model.model_type);
            const accuracies = models.map(model => model.accuracy * 100);
            const precisions = models.map(model => model.precision * 100);
            const recalls = models.map(model => model.recall * 100);
            const f1Scores = models.map(model => model.f1_score * 100);
            
            const trace1 = {
                x: modelTypes,
                y: accuracies,
                name: 'Accuracy',
                type: 'bar',
                marker: {color: '#667eea'}
            };
            
            const trace2 = {
                x: modelTypes,
                y: precisions,
                name: 'Precision',
                type: 'bar',
                marker: {color: '#28a745'}
            };
            
            const trace3 = {
                x: modelTypes,
                y: recalls,
                name: 'Recall',
                type: 'bar',
                marker: {color: '#ffc107'}
            };
            
            const trace4 = {
                x: modelTypes,
                y: f1Scores,
                name: 'F1 Score',
                type: 'bar',
                marker: {color: '#dc3545'}
            };
            
            const layout = {
                title: 'Model Performance Metrics',
                xaxis: {title: 'Model Type'},
                yaxis: {title: 'Score (%)', range: [0, 100]},
                barmode: 'group',
                legend: {orientation: 'h', y: -0.2},
                margin: {l: 50, r: 20, t: 50, b: 100},
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white'
            };
            
            Plotly.newPlot('model-performance-chart', [trace1, trace2, trace3, trace4], layout);
        }
        
        function refreshModelPerformance() {
            loadModelPerformance();
        }
        
        function selectModel(modelType) {
            document.getElementById('model_type').value = modelType;
            alert(`✅ Model ${modelType} selected for predictions`);
        }
    </script>
{% endblock %}